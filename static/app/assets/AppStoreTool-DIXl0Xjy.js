import{r,c as G,j as m}from"./index-C6i-a171.js";import{P as K}from"./PlatformToolLayout-Z7gxyS7o.js";const v=[{code:"US",label:"United States"},{code:"GB",label:"United Kingdom"},{code:"CA",label:"Canada"},{code:"AU",label:"Australia"},{code:"DE",label:"Germany"},{code:"FR",label:"France"},{code:"ES",label:"Spain"},{code:"IT",label:"Italy"},{code:"NL",label:"Netherlands"},{code:"BE",label:"Belgium"},{code:"JP",label:"Japan"}],R=s=>{const y=(s||"").toUpperCase();return v.find(l=>l.code===y)?.code??"US"},q=s=>{const{keyword:y,setKeyword:g,country:l,ui:b,uiFallback:S}=s,o=y??"",[d,E]=r.useState(()=>R(l)),[C,p]=r.useState([]),[U,j]=r.useState(!1),[P,n]=r.useState(null),c=r.useRef(!1),t=r.useMemo(()=>G(b,S),[b,S]),k=r.useMemo(()=>v,[]);r.useEffect(()=>{E(R(l))},[l]);const i=r.useCallback(async a=>{const h=a.trim();if(!h){p([]),n(null);return}j(!0),n(null);try{const f=new URLSearchParams({q:h,country:d,limit:"15"}),u=await fetch(`/api/platforms/appstore?${f.toString()}`);if(!u.ok){const e=await u.json().catch(()=>null);throw new Error(e?.error||t("platform.appstore.error.fetch"))}const w=await u.json(),x=(Array.isArray(w?.results)?w.results:[]).map((e,A)=>{const F=e.trackName||h,L=[e.artistName,e.primaryGenreName].filter(Boolean),T=typeof e.averageUserRating=="number"?`${e.averageUserRating.toFixed(1)}★${e.userRatingCount?` (${e.userRatingCount.toLocaleString()})`:""}`:null,$=e.formattedPrice||(typeof e.price=="number"?e.price===0?t("platform.appstore.price.included"):`${e.price} ${e.currency||""}`:null),B=[T,$].filter(Boolean);return{title:F,subtitle:L.join(" • ")||void 0,metric:B.join(" • ")||t("platform.appstore.metric.rank",{rank:A+1})}});p(x),x.length===0&&n(t("platform.appstore.error.none"))}catch(f){const u=f instanceof Error?f.message:t("platform.appstore.error.generic");n(u),p([])}finally{j(!1)}},[d,t]);r.useEffect(()=>{if(!o.trim()){p([]),n(null),c.current=!1;return}c.current||(c.current=!0,i(o))},[o,i]),r.useEffect(()=>{o.trim()&&c.current&&i(o)},[d,o,i]);const N=m.jsx("div",{className:"platform-tool__filters",children:m.jsxs("label",{htmlFor:"appstore-country",children:[t("platform.appstore.filters.store"),m.jsx("select",{id:"appstore-country",value:d,onChange:a=>{E(a.target.value),c.current=!1},children:k.map(a=>m.jsx("option",{value:a.code,children:a.label},a.code))})]})});return m.jsx(K,{platformName:t("platform.appstore.meta.name"),keyword:o,onKeywordChange:g,onSearch:i,description:t("platform.appstore.description"),extraFilters:N,results:C,placeholder:t("platform.appstore.placeholder"),loading:U,error:P,emptyState:t("platform.appstore.empty"),controls:s.locationControls,onGlobalSearch:s.onGlobalSearch,globalLoading:s.globalLoading,translate:t})};export{q as default};
